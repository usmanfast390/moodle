{"version":3,"file":"template-edit.min.js","sources":["../src/template-edit.js"],"sourcesContent":["// This file is part of the tool_certificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module used when editing a single template\n *\n * @module     tool_certificate/template-edit\n * @copyright  2019 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'jqueryui', 'core_form/modalform', 'core/notification', 'core/str', 'core/ajax', 'core/sortable_list'],\nfunction($, jqui, ModalForm, Notification, Str, Ajax, SortableList) {\n\n    var deleteElement = function(e) {\n        e.preventDefault();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'deleteelementconfirm', component: 'tool_certificate', param: $(e.currentTarget).attr('data-name')},\n            {key: 'delete', component: 'moodle'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                var promises = Ajax.call([\n                    {methodname: 'tool_certificate_delete_element',\n                        args: {id: $(e.currentTarget).attr('data-id')}}\n                ]);\n                promises[0].done(function() {\n                    // TODO reload only list of elements.\n                    window.location.reload();\n                }).fail(Notification.exception);\n            });\n        }).fail(Notification.exception);\n    };\n\n    var editElement = function(e) {\n        e.preventDefault();\n        if ($(e.currentTarget).hasClass('isdragged')) {\n            return;\n        }\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\edit_element_form',\n            args: {id: $(e.currentTarget).attr('data-id')},\n            modalConfig: {title: Str.get_string('editelement', 'tool_certificate', $(e.currentTarget).attr('data-name'))},\n            saveButtonText: Str.get_string('save'),\n            returnFocus: $(e.currentTarget),\n        });\n        modal.addEventListener(modal.events.FORM_SUBMITTED, function() {\n            window.location.reload();\n        });\n        modal.show();\n    };\n\n    var addElement = function(e) {\n        e.preventDefault();\n        var pageid = $(e.currentTarget).attr('data-pageid'),\n            type = $(e.currentTarget).attr('data-element');\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\edit_element_form',\n            args: {pageid: pageid, element: type},\n            modalConfig: {title: Str.get_string('addelementwithname', 'tool_certificate', $(e.currentTarget).text())},\n            saveButtonText: Str.get_string('save'),\n            returnFocus: $(e.currentTarget),\n        });\n        modal.addEventListener(modal.events.FORM_SUBMITTED, function() {\n            window.location.reload();\n        });\n        modal.show();\n    };\n\n    var deletePage = function(e) {\n        e.preventDefault();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'deletepageconfirm', component: 'tool_certificate'},\n            {key: 'delete', component: 'moodle'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                window.location.href = $(e.currentTarget).attr('href');\n            });\n        }).fail(Notification.exception);\n    };\n\n    var addPage = function(e) {\n        e.preventDefault();\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\form\\\\page',\n            args: {templateid: $('[data-region=\"template\"][data-id]').attr('data-id')},\n            modalConfig: {title: Str.get_string('addcertpage', 'tool_certificate')},\n            saveButtonText: Str.get_string('save'),\n            returnFocus: $(e.currentTarget),\n        });\n        modal.addEventListener(modal.events.FORM_SUBMITTED, function() {\n            window.location.reload();\n        });\n        modal.show();\n    };\n\n    var editPage = function(e) {\n        e.preventDefault();\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\form\\\\page',\n            args: {id: $(e.currentTarget).attr('data-id')},\n            modalConfig: {title: Str.get_string('editpage', 'tool_certificate', $(e.currentTarget).attr('data-pagenumber'))},\n            saveButtonText: Str.get_string('save'),\n            returnFocus: $(e.currentTarget),\n        });\n        modal.addEventListener(modal.events.FORM_SUBMITTED, function() {\n            window.location.reload();\n        });\n        modal.show();\n    };\n\n    var initSorting = function() {\n        $('[data-region=\"page\"]').each(function() {\n            var sortablelist = new SortableList($(this).find('[data-region=\"elementlist\"]'));\n            sortablelist.getElementName = function(element) {\n                return $.Deferred().resolve(element.find('a.quickeditlink').text());\n            };\n            $(this).on(SortableList.EVENTS.DROP, '[data-region=\"elementlist\"] > *', function(_, info) {\n                if (info.positionChanged) {\n                    var request = {\n                        methodname: 'tool_certificate_update_element',\n                        args: {id: info.element.data('id'), sequence: info.element.index() + 1}\n                    };\n                    Ajax.call([request])[0].fail(Notification.exception);\n                }\n            });\n        });\n    };\n\n    var mmToPx = function(value) {\n        // TODO replace 2 with a ratio.\n        return parseFloat(value) * 2;\n    };\n\n    var pxToMm = function(value) {\n        // TODO replace 2 with a ratio.\n        return Math.round(parseFloat(value) / 2);\n    };\n\n    var ptToPx = function(value) {\n        // 1pt = 1/72 inch = 0.352778 mm .\n        return mmToPx(value) * 0.352778;\n    };\n\n    var recalculatePDF = function() {\n        var page = $(this);\n        page.css(\"width\", mmToPx(page.data('pagewidth')) + 'px');\n        page.css(\"height\", mmToPx(page.data('pageheight')) + 'px');\n        page.find('[data-width]').each(function() {\n            $(this).css('width', mmToPx($(this).data('width')) + 'px');\n        });\n        page.find('[data-height]').each(function() {\n            $(this).css('height', mmToPx($(this).data('height')) + 'px');\n        });\n        page.find('[data-fontsize]').each(function() {\n            $(this).css('font-size', ptToPx($(this).data('fontsize')) + 'px');\n        });\n        page.find('[data-posy]').each(function() {\n            $(this).css('top', mmToPx($(this).data('posy')) + 'px');\n        });\n        page.find('[data-posx]').each(function() {\n            // For elements with a refpoint calculate the posx of the top left corner.\n            // Refpoint=0 - no change, =1 - move left by half of the width, =2 - move left by the width.\n            var left = mmToPx($(this).data('posx')),\n                refpoint = $(this).data('refpoint') ? parseInt($(this).data('refpoint')) : 0,\n                offset = refpoint ? parseInt($(this).width()) * refpoint / 2 : 0;\n            $(this).css(\"left\", (left - offset) + 'px');\n        });\n        page.addClass('recalculated');\n        // Init draggable.\n        page.find('[data-drag-type=\"move\"]').draggable();\n    };\n\n    var initDraggable = function() {\n        var selector = '[data-region=\"pdf\"] [data-drag-type=\"move\"]';\n        $('body')\n            .on('mousedown', selector, function(e) {\n                var el = $(e.currentTarget),\n                    page = el.closest('[data-region=\"pdf\"]');\n                // Set element \"pagecenter\" to be the same width as this element and place it in the page center.\n                page.find('[data-region=\"pagecenter\"]')\n                    .css(\"left\", (mmToPx(page.data('pagecentre')) - el.width() / 2) + \"px\")\n                    .css(\"width\", el.width() + \"px\");\n                el.draggable({\n                    // Snap to elements only if Shift is not held.\n                    snap: e.shiftKey ? false : '.snapdraggable',\n                    snapMode: 'inner',\n                    snapTolerance: 10,\n                    // Set containment so it can't be moved far away from the page outlines.\n                    containment: [\n                        page.offset().left - el.width(),\n                        page.offset().top - el.height(),\n\n                        page.offset().left + mmToPx(page.data('pagewidth')),\n                        page.offset().top + mmToPx(page.data('pageheight'))\n                    ],\n                });\n            })\n            .on('dragstart', selector, function(e) {\n                $(e.currentTarget).addClass('isdragged');\n            })\n            .on('dragstop', selector, function(e) {\n                var el = $(e.currentTarget),\n                    page = el.closest('[data-region=\"pdf\"]'),\n                    refpoint = parseInt($(this).data('refpoint')),\n                    offset = refpoint ? parseInt($(this).width()) * refpoint / 2 : 0,\n                    left = pxToMm(el.offset().left - page.offset().left + offset),\n                    top = pxToMm(el.offset().top - page.offset().top);\n                setTimeout(function() {\n                    el.removeClass('isdragged');\n                }, 100);\n                var request = {\n                    methodname: 'tool_certificate_update_element',\n                    args: {id: el.data('id'), posx: left, posy: top}\n                };\n                Ajax.call([request])[0].fail(Notification.exception);\n            });\n    };\n\n    return {\n        init: function() {\n            // Add button is not inside a tab, so we can't use Tab.addButtonOnClick .\n            $('[data-action=\"deleteelement\"]').on('click', deleteElement);\n            $('[data-action=\"editelement\"]').on('click', editElement);\n            $('[data-action=\"addelement\"]').on('click', addElement);\n            $('[data-action=\"deletepage\"]').on('click', deletePage);\n            $('[data-element=\"addbutton\"]').on('click', addPage);\n            $('[data-action=\"editpage\"]').on('click', editPage);\n            initSorting();\n            initDraggable();\n            $('[data-region=\"pdf\"]').each(recalculatePDF);\n        }\n    };\n});\n"],"names":["define","$","jqui","ModalForm","Notification","Str","Ajax","SortableList","deleteElement","e","preventDefault","get_strings","key","component","param","currentTarget","attr","done","s","confirm","call","methodname","args","id","window","location","reload","fail","exception","editElement","hasClass","modal","formClass","modalConfig","title","get_string","saveButtonText","returnFocus","addEventListener","events","FORM_SUBMITTED","show","addElement","pageid","type","element","text","deletePage","href","addPage","templateid","editPage","mmToPx","value","parseFloat","pxToMm","Math","round","recalculatePDF","page","this","css","data","find","each","left","refpoint","parseInt","offset","width","addClass","draggable","init","selector","on","getElementName","Deferred","resolve","EVENTS","DROP","_","info","positionChanged","request","sequence","index","el","closest","snap","shiftKey","snapMode","snapTolerance","containment","top","height","setTimeout","removeClass","posx","posy"],"mappings":"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"}