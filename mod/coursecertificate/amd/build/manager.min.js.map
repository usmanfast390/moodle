{"version":3,"file":"manager.min.js","sources":["../src/manager.js"],"sourcesContent":["// This file is part of the mod_coursecertificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module instantiates the functionality for actions on course certificates.\n *\n * @module      mod_coursecertificate/manager\n * @copyright   2020 Mikel Mart√≠n <mikel@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport Notification from 'core/notification';\nimport {get_strings as getStrings} from 'core/str';\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\nimport Pending from 'core/pending';\n\n/** @type {Object} The list of selectors for the coursecertificate module. */\nconst SELECTORS = {\n    AUTOMATICSENDREGION: \"[data-region='automaticsend-alert']\",\n    HIDDENWARNING: \".hidden-warning\",\n    NOAUTOSENDINFO: \".noautosend-info\",\n    REPORTREGION: \"[data-region='issues-report']\",\n    TOGGLEAUTOMATICSEND: \"[data-action='toggle-automaticsend']\",\n    LOADING: \".loading-overlay\"\n},\n/** @type {Object} The list of templates for the coursecertificate module. */\nTEMPLATES = {\n    AUTOMATICSENDALERT: 'mod_coursecertificate/automaticsend_alert',\n    ISSUESREPORT: 'mod_coursecertificate/issues_report'\n},\n/** @type {Object} The list of services for the coursecertificate module. */\nSERVICES = {\n    UPDATEAUTOMATICSEND: 'mod_coursecertificate_update_automaticsend',\n};\n\n/**\n * Show/Hide selector.\n *\n * @param {string} selector\n * @param {boolean} visible\n */\nfunction setVisibility(selector, visible) {\n    document.querySelector(selector).classList.toggle('invisible', !visible);\n}\n\n/**\n * Toggle the automaticsend setting on/off for coursecertificate.\n *\n * @param {Element} automaticsendregion\n */\nfunction toggleAutomaticSend(automaticsendregion) {\n    const {certificateid, automaticsend} =\n        automaticsendregion.querySelector(SELECTORS.TOGGLEAUTOMATICSEND).dataset;\n    const newstatus = automaticsend === '0';\n    let showhiddenwarning, shownoautosendinfo, pendingPromise;\n\n    // Build list of strings.\n    const strings = [\n        {'key': 'confirmation', component: 'admin'},\n        {'key': 'confirm', component: 'moodle'},\n    ];\n    if (newstatus) {\n        strings.push({'key': 'enableautomaticsendpopup', component: 'coursecertificate'});\n    } else {\n        strings.push({'key': 'disableautomaticsend', component: 'coursecertificate'});\n    }\n\n    pendingPromise = new Pending('mod_coursecertificate/manager:toggleAutomaticSendgetStrings');\n    getStrings(strings).then(([title, saveLabel, question]) => {\n        pendingPromise.resolve();\n        return Notification.saveCancelPromise(title, question, saveLabel);\n    }).then(() => {\n        pendingPromise = new Pending('mod_coursecertificate/manager:toggleAutomaticSend');\n        // Show loading template.\n        setVisibility(SELECTORS.LOADING, true);\n        // Call to webservice.\n        return Ajax.call([{\n            methodname: SERVICES.UPDATEAUTOMATICSEND,\n            args: {id: certificateid, automaticsend: newstatus}\n        }])[0];\n    }).then((result) => {\n        ({showhiddenwarning, shownoautosendinfo} = result);\n        return Templates.render(TEMPLATES.AUTOMATICSENDALERT,\n            {certificateid: certificateid, automaticsend: newstatus}, '');\n    }).then((html) => {\n        Templates.replaceNodeContents(automaticsendregion, html, '');\n        setVisibility(SELECTORS.HIDDENWARNING, showhiddenwarning);\n        setVisibility(SELECTORS.NOAUTOSENDINFO, shownoautosendinfo);\n        return pendingPromise.resolve();\n    }).catch((e) => {\n        if (e.type === 'modal-save-cancel:cancel') {\n            // Clicked cancel.\n            return;\n        }\n        Notification.exception(e);\n    });\n}\n\n/**\n * Initialise module\n */\nexport function init() {\n    const automaticsendregion = document.querySelector(SELECTORS.AUTOMATICSENDREGION);\n    if (automaticsendregion) {\n        automaticsendregion.addEventListener('click', (e) => {\n            if (e.target.closest(SELECTORS.TOGGLEAUTOMATICSEND)) {\n                e.preventDefault();\n                toggleAutomaticSend(automaticsendregion);\n            }\n        });\n    }\n}\n"],"names":["automaticsendregion","document","querySelector","SELECTORS","addEventListener","e","target","closest","preventDefault","certificateid","automaticsend","dataset","newstatus","showhiddenwarning","shownoautosendinfo","pendingPromise","strings","component","push","Pending","then","_ref","title","saveLabel","question","resolve","Notification","saveCancelPromise","setVisibility","Ajax","call","methodname","SERVICES","args","id","result","Templates","render","TEMPLATES","html","replaceNodeContents","catch","type","exception","toggleAutomaticSend","selector","visible","classList","toggle"],"mappings":"wWAqHUA,oBAAsBC,SAASC,cAAcC,+BAC/CH,qBACAA,oBAAoBI,iBAAiB,SAAUC,IACvCA,EAAEC,OAAOC,QAAQJ,iCACjBE,EAAEG,0BAxDWR,2BACnBS,cAACA,cAADC,cAAgBA,eAClBV,oBAAoBE,cAAcC,+BAA+BQ,QAC/DC,UAA8B,MAAlBF,kBACdG,kBAAmBC,mBAAoBC,qBAGrCC,QAAU,CACZ,KAAQ,eAAgBC,UAAW,SACnC,KAAQ,UAAWA,UAAW,WAE9BL,UACAI,QAAQE,KAAK,KAAQ,2BAA4BD,UAAW,sBAE5DD,QAAQE,KAAK,KAAQ,uBAAwBD,UAAW,sBAG5DF,eAAiB,IAAII,iBAAQ,oFAClBH,SAASI,MAAKC,WAAEC,MAAOC,UAAWC,sBACzCT,eAAeU,UACRC,sBAAaC,kBAAkBL,MAAOE,SAAUD,cACxDH,MAAK,KACJL,eAAiB,IAAII,iBAAQ,qDAE7BS,cAAczB,mBAAmB,GAE1B0B,cAAKC,KAAK,CAAC,CACdC,WAAYC,6BACZC,KAAM,CAACC,GAAIzB,cAAeC,cAAeE,cACzC,MACLQ,MAAMe,WACHtB,kBAAAA,kBAAmBC,mBAAAA,oBAAsBqB,QACpCC,mBAAUC,OAAOC,6BACpB,CAAC7B,cAAeA,cAAeC,cAAeE,WAAY,OAC/DQ,MAAMmB,0BACKC,oBAAoBxC,oBAAqBuC,KAAM,IACzDX,cAAczB,wBAAyBU,mBACvCe,cAAczB,yBAA0BW,oBACjCC,eAAeU,aACvBgB,OAAOpC,IACS,6BAAXA,EAAEqC,4BAIOC,UAAUtC,MAafuC,CAAoB5C,gNA1F9BG,8BACmB,sCADnBA,wBAEa,kBAFbA,yBAGc,mBAHdA,8BAKmB,uCALnBA,kBAMO,mBAGbmC,6BACwB,4CAIxBN,6BACyB,sDAShBJ,cAAciB,SAAUC,SAC7B7C,SAASC,cAAc2C,UAAUE,UAAUC,OAAO,aAAcF"}